import axios from 'axios';
import { BrowserRouter as Router, Routes, Route, useNavigate, useLocation } from 'react-router-dom';
import './App.css';
import { GoogleOAuthProvider, useGoogleLogin } from '@react-oauth/google';
import { Canvas } from '@react-three/fiber';
import MyElement3D from './MyElement3D';
import { useState, useEffect } from 'react';
import Modal from './Modal';
import LPRecordsPage from './LPRecordsPage';
import SongSelectionModal from './SongSelectionModal';
import { searchYouTubeVideo } from './utils/youtubeSearch';
import YouTubePlayer from './YouTubePlayer';


const CLIENT_ID = import.meta.env.VITE_YW_GOOGLE_CLIENT_ID;
console.log('Client ID:', CLIENT_ID);

function App() {
  return (
    <GoogleOAuthProvider clientId={CLIENT_ID}>
      <AppContent />
    </GoogleOAuthProvider>
  );
}


function AppContent() {
  const [hoveredText, setHoveredText] = useState("");
  const [isAnimating, setIsAnimating] = useState(false);
  const [isTestingSong, setIsTestingSong] = useState(false);
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [showLpSelection, setShowLpSelection] = useState(false);
  const [recommendedSongs, setRecommendedSongs] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [showSongSelectionModal, setShowSongSelectionModal] = useState(false);
  const [isLoading, setIsLoading] = useState(false)
  const [loginMessage, setLoginMessage] = useState("");
  const [loadingStage, setLoadingStage] = useState(0); // ÏßÑÌñâ Îã®Í≥Ñ
  const loadingSteps = [
      "Í∏ÄÏùÑ Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§.",
      "Í∏ÄÏóêÏÑú Í∞êÏ†ïÍ≥º ÌÇ§ÏõåÎìúÎ•º Ï∂îÏ∂úÌïòÍ≥† ÏûàÏäµÎãàÎã§.",
      "LP ÌëúÏßÄÎ•º ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§.",
      "ÏïåÎßûÎäî ÎÖ∏ÎûòÎ•º Í≤ÄÏÉâ Ï§ëÏûÖÎãàÎã§.",
  ];

const specialChars = ["‚ô§", "‚ôß", "‚Ä†", "¬£", "¬¢"];
const [specialCharIndex, setSpecialCharIndex] = useState(0);
  const [userId, setUserId] = useState(() => {
    const savedUserId = localStorage.getItem('userId');
    return savedUserId || null;
  });
  const [youTubePlayer, setYouTubePlayer] = useState(null);

  const navigate = useNavigate();
  const location = useLocation();

  const defaultSong = {
    title: "Reality",
    artist: "Richard Sanderson",
    videoId: "T5dnEKqOaHw",
  };
  const [youTubeVideoId, setYouTubeVideoId] = useState(defaultSong.videoId);

  const [selectedLP, setSelectedLP] = useState(() => {
    const savedLP = localStorage.getItem('selectedLP');
    return savedLP ? JSON.parse(savedLP) : null;
  });

  useEffect(() => {
    const storedUserId = localStorage.getItem('userId');
    console.log("üîç useEffect - storedUserId:", storedUserId);
  
    if (storedUserId) {
      setUserId(storedUserId);
      setIsLoggedIn(true);
    } else {
      setIsLoggedIn(false);
      setSelectedLP({ song: defaultSong }); // Î°úÍ∑∏ÏïÑÏõÉ Ïãú Í∏∞Î≥∏ ÏùåÏïÖ ÏÑ§Ï†ï
    }
  }, []);
  
  useEffect(() => {
    if (isLoggedIn) {
      const savedLP = localStorage.getItem('selectedLP');
      if (savedLP) {
        console.log("üìå LocalStorageÏóêÏÑú Î∂àÎü¨Ïò® LP:", JSON.parse(savedLP));
        setSelectedLP(JSON.parse(savedLP));
      }
    }
  }, [isLoggedIn]); // isLoggedInÏù¥ trueÏùº ÎïåÎßå Ïã§Ìñâ
  

  useEffect(() => {
    if (isLoggedIn) {
      if (selectedLP?.song?.videoId) {
        console.log("üîÑ Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú: ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉù ÏùåÏïÖ Ïû¨ÏÉù", selectedLP.song.videoId);
        setYouTubeVideoId(selectedLP.song.videoId);
      }
    } else {
      console.log("üîÑ Î°úÍ∑∏ÏïÑÏõÉ ÏÉÅÌÉú: Í∏∞Î≥∏ ÏùåÏïÖ Ïû¨ÏÉù", defaultSong.videoId);
      setYouTubeVideoId(defaultSong.videoId);
    }
  }, [isLoggedIn, selectedLP]);
  

  useEffect(() => {
    if (isLoading) {
        const interval = setInterval(() => {
            setSpecialCharIndex((prev) => (prev + 1) % specialChars.length);
        }, 500); // 0.5Ï¥àÎßàÎã§ Î≥ÄÍ≤Ω
        return () => clearInterval(interval);
    }
  }, [isLoading]);


  const handleSaveDiary = async (diaryText) => {
    if (!diaryText.trim()) {
      alert("ÏùºÍ∏∞ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
      return;
    }

    setIsLoading(true);
    setSpecialCharIndex(0);
    setLoadingStage(0);
    await new Promise(resolve => setTimeout(resolve, 1500)); 

    try {
      setLoadingStage(1);

      const response = await axios.post('http://localhost:8000/lps/generate', {
        user_id: userId,
        text: diaryText,
      }, {
        headers: {
          'Content-Type': 'application/json',
        },
      });
      console.log("Generated LP:", response);
      setLoadingStage(2);
      await new Promise(resolve => setTimeout(resolve, 1500)); // 1Ï¥à ÎåÄÍ∏∞

      setSelectedLP(response.data.diary);
      localStorage.setItem('selectedLP', JSON.stringify(response.data));
      console.log("SET Selected LP:", selectedLP);
      setRecommendedSongs(response.data.song);
      setLoadingStage(3);
      await new Promise(resolve => setTimeout(resolve, 1500)); // 1Ï¥à ÎåÄÍ∏∞

      setShowModal(false);
      setShowSongSelectionModal(true);

    } catch (error) {
      console.error("Error:", error.response?.data || error.message);
      alert("LP Ïª§Î≤Ñ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
    }finally {
      setIsLoading(false); // Î°úÎî© ÏÉÅÌÉú Ï¢ÖÎ£å
    }
  };

  const handleSongSelect = async (song) => {
    try {
      if (!selectedLP?._id) {
        alert("LP Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.");
        return;
      }

      console.log("Selected Song:", song.title, song.artist);
      console.log("Selected LP INFO:", selectedLP);

      const videoId = await searchYouTubeVideo(song.title, song.artist);
      if (!videoId) {
        alert('YouTubeÏóêÏÑú Ìï¥Îãπ ÎÖ∏ÎûòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        return;
      }
      console.log("VIDEO ID: ", videoId)
      setYouTubeVideoId(videoId);


      const updatedLP = { 
        ...selectedLP,
        song: {
          ...selectedLP.song,
          title: song.title,
          artist: song.artist,
          videoId: videoId
        }
      };

      setSelectedLP(updatedLP);
      localStorage.setItem('selectedLP', JSON.stringify(updatedLP));
      console.log("Updated LP:", updatedLP);

      const response = await axios.post('http://localhost:8000/lps/select-song', {
        user_id: updatedLP.user_id,
        diary_id: updatedLP._id.toString(),
        song:updatedLP.song
      }, {
          headers: {
            'Content-Type': 'application/json',
          },
      });
      console.log("ÎÖ∏Îûò Ï∂îÍ∞ÄÎê®: ", response)
  
      // ÎÖ∏Îûò ÏÑ†ÌÉù Î™®Îã¨ Îã´Í∏∞
      handlePlayVideo(null);
      setShowSongSelectionModal(false);
  
      alert("ÎÖ∏ÎûòÍ∞Ä LPÏóê Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!");
      window.location.reload();

    } catch (error) {
      console.error("ÎÖ∏Îûò ÏÑ†ÌÉù ÏóêÎü¨:", error);
      alert("ÎÖ∏Îûò ÏÑ†ÌÉùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
    }
  };

  const handleStartClick = () => {
    console.log("Current Animation State:", isAnimating);
    console.log("-- Ïû¨ÏÉùÌï† ÎπÑÎîîÏò§ ÏïÑÏù¥ÎîîÎäî: ", youTubeVideoId);
    if (isAnimating) {
      // Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ Î©àÏ∂§ ‚Üí ÎπÑÎîîÏò§Î•º pause
      console.log("Pausing video & stopping animation...");
      if (youTubePlayer) {
        youTubePlayer.pauseVideo();
      }
    } else {
      // Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ ÏãúÏûë ‚Üí ÎπÑÎîîÏò§Î•º play
      console.log("Playing video & starting animation...");
      if (youTubePlayer && !isTestingSong) {
        youTubePlayer.playVideo();
      }
    }

    // ÎßàÏßÄÎßâÏóê ÏÉÅÌÉúÎ•º ÌÜ†Í∏ÄÌï¥Ï§ÄÎã§
    setIsAnimating(!isAnimating);
  };
  

  const handlef1Click = () => {
    if (youTubePlayer) youTubePlayer.setVolume(10);  // 0~100
  };
  const handlef2Click = () => {
    if (youTubePlayer) youTubePlayer.setVolume(40);
  };
  const handlef3Click = () => {
    if (youTubePlayer) youTubePlayer.setVolume(70);
  };
  const handlef4Click = () => {
    if (youTubePlayer) youTubePlayer.setVolume(100);
  };
  
  const handlePlayerReady = (player) => {
    console.log("handlePlayerReady called:", player);
    setYouTubePlayer(player);
    player.setVolume(40);
    if (isAnimating) {
      console.log('ÎÖ∏Îûò Ïû¨ÏÉù Í∞ÄÎä•');
      player.playVideo();  // LPÍ∞Ä ÌöåÏ†Ñ Ï§ëÏùº ÎïåÎßå ÏùåÏïÖ Ïû¨ÏÉù
    } else {
      console.log('ÎÖ∏Îûò Ïû¨ÏÉù Î∂àÍ∞ÄÎä•');
      player.pauseVideo();  // LPÍ∞Ä Î©àÏ∂∞ÏûàÏúºÎ©¥ ÏûêÎèô Ïû¨ÏÉù Î∞©ÏßÄ
    }
  };
  
  const handleGoogleLogin = useGoogleLogin({
    flow: "implicit",
    scope: "openid email profile",
    onSuccess: async (response) => {
      console.log("Login Success:", response);

      if (!response.access_token) {
        console.error("access_token is missing");
        return;
      }

      await fetch("http://localhost:8000/users/auth/google", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ access_token: response.access_token }),
      })
        .then((res) => res.json())
        .then((data) => {
          console.log("Server Response:", data);
          
          localStorage.setItem('userId', data.user_id);
          console.log("User ID:", data.user_id);
          setUserId(data.user_id);
          setIsLoggedIn(true);
        })
        .catch((err) => console.error("Error saving user:", err));
      
    },
    onError: () => {
      console.error("Login Failed");
    },
  });

  const handleRecordClick = () => {
    if(!isLoggedIn){
      setLoginMessage("Í≥†ÏñëÏù¥Î•º ÎàåÎü¨ÏÑú Î°úÍ∑∏Ïù∏ÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî!");
      setTimeout(() => setLoginMessage(""), 5000);
      return;
    }else{
      navigate('/lp-records', { state: { userId: userId } }); 
    }
  };

  const handleTableClick = () => {
    if(!isLoggedIn){
      setLoginMessage("Í≥†ÏñëÏù¥Î•º ÎàåÎü¨ÏÑú Î°úÍ∑∏Ïù∏ÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî!");
      console.log("Î°úÍ∑∏Ïù∏Ìï¥Îû¥", loginMessage)
      setTimeout(() => setLoginMessage(""), 5000);
      return;
    }else{
      setShowModal(true)
    }
  };

  const handleCatClick = () => {
    if (isLoggedIn) {
      console.log("üî¥ Î°úÍ∑∏ÏïÑÏõÉ ÏßÑÌñâ...");
      
      // ‚úÖ ÏÉÅÌÉú Î≥ÄÍ≤Ω ÏàúÏÑú Î™ÖÌôïÌïòÍ≤å ÏÑ§Ï†ï
      localStorage.removeItem("userId");
      localStorage.removeItem("selectedLP");
  
      setUserId(null);
      setIsLoggedIn(false);
  
      console.log("‚úÖ Î°úÍ∑∏ÏïÑÏõÉ ÏôÑÎ£å. Í∏∞Î≥∏ LPÏôÄ ÎÖ∏ÎûòÎ°ú Î≥ÄÍ≤ΩÎê®.");
      window.location.reload();
    } else {
      handleGoogleLogin();
    }
  };
  

  const handlePlayVideo = (videoId) => {
    console.log(`handlePlayVideo Ìò∏Ï∂úÎê®, videoId: ${videoId}`);

    if (youTubePlayer) {
      if (videoId === null) {
        console.log("ÎπÑÎîîÏò§ Ï†ïÏßÄ ÏöîÏ≤≠Îê®");
        youTubePlayer.pauseVideo();
        setIsTestingSong(false);
      } else {
        console.log(`ÎπÑÎîîÏò§ Î°úÎìú Î∞è Ïû¨ÏÉù: ${videoId}`);
        setYouTubeVideoId(videoId);
        youTubePlayer.loadVideoById(videoId);
        youTubePlayer.playVideo();
        setIsTestingSong(true);
      }
    }
  };

  

  

  return (
    <>
      {showLpSelection ? (
        <LpSelection onLpSelect={handleLpSelect} />
      ) : (
        <>
          {hoveredText && (
                <div className="hovered-text"> {hoveredText} </div>
            )}
          <Canvas camera={{ near: 0.1, far: 100, position: [-50, 15, 0] }}>
            <MyElement3D 
              isAnimating={isAnimating} 
              onRecordClick={handleRecordClick} 
              onCatClick={handleCatClick} 
              onTableClick={handleTableClick} 
              onStartClick={handleStartClick} 
              onf1Click={handlef1Click} 
              onf2Click={handlef2Click} 
              onf3Click={handlef3Click} 
              onf4Click={handlef4Click} 
              isLoggedIn={isLoggedIn} 
              selectedLP={selectedLP} 
              setHoveredText={setHoveredText}/>
          </Canvas>

          {loginMessage && (
              <div className="login-message">
                  {loginMessage}
              </div>
          )}


          {isLoading && (
              <div className="loading-overlay">
                  <div className="loading-content">
                      <p className="M1">"Ïò§ÎäòÏùò LPÎ•º ÎßåÎì§Í≥† ÏûàÏäµÎãàÎã§! Ïû†ÏãúÎßå Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî:D"</p>
                      <p className="M2">{specialChars.slice(0, specialCharIndex + 1).join(" ")}</p>
                      <p className="M3">{loadingSteps[loadingStage]}</p>
                  </div>
              </div>
          )}

          {!isLoading && (
            <Modal
              isOpen={showModal}
              onClose={() => setShowModal(false)}
              onSave={(diaryText) => handleSaveDiary(diaryText)}
            />
          )}

          <SongSelectionModal
            isOpen={showSongSelectionModal}
            recommendedSongs={recommendedSongs}
            onClose={() => setShowSongSelectionModal(false)}
            onSongSelect={handleSongSelect}
            onPlay={handlePlayVideo}
          />

          
            <div>
              <YouTubePlayer 
                videoId={youTubeVideoId} 
                onPlayerReady={handlePlayerReady}/>
            </div>
          
        </>
      )}
    </>
  );
}

function AppWrapper() {
  return (
    <Router>
      <Routes>
        <Route path="/" element={<App />} />
        <Route path="/lp-records" element={<LPRecordsPage />} />
      </Routes>
    </Router>
  );
}

export default AppWrapper;